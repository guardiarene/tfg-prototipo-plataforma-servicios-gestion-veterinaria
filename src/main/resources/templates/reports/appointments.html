<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Reporte de Solicitudes y Servicios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div th:replace="~{layouts/navbar :: navbar('VETERINARIAN')}"></div>
<div class="container py-4">
    <div class="reporte-header">
        <h2 class="mb-3">Reporte</h2>
        <form method="POST" th:action="@{/reports/appointments}">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Desde:</label>
                    <input class="form-control" name="startDate" required th:value="${startDate}" type="date">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Hasta:</label>
                    <input class="form-control" name="endDate" required th:value="${endDate}" type="date">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary" type="submit">Generar Reporte</button>
                    <a class="btn btn-secondary" th:href="@{/veterinarian/dashboard}">Volver</a>
                </div>
            </div>
        </form>
        <div class="mt-3 text-muted" th:if="${startDate != null and endDate != null}">
            Reporte generado desde el <span th:text="${#temporals.format(startDate, 'dd/MM/yyyy')}"></span>
            hasta el <span th:text="${#temporals.format(endDate, 'dd/MM/yyyy')}"></span>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card card-estadistica">
                <div class="card-body">
                    <h5 class="card-title">Turnos por Día</h5>
                    <div class="text-center py-4">
                        <canvas id="graficoAppointments"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card card-estadistica">
                <div class="card-body">
                    <h5 class="card-title mb-4">Detalle de Turnos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th class="text-end">Cantidad</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="appointment : ${appointments}">
                                <td th:text="${#temporals.format(appointment.key, 'dd/MM/yyyy')}"></td>
                                <td class="text-end" th:text="${appointment.value}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="text-center py-5" th:if="${#maps.isEmpty(appointments)}">
    <div class="alert alert-info" role="alert">
        No se encontraron registros para el período seleccionado
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const appointmentsData = JSON.parse(/*[[${appointmentsJson}]]*/ '{}');
        const colores = {
            fondo: 'rgba(54, 162, 235, 0.2)',
            borde: 'rgba(54, 162, 235, 1)',
            hover: 'rgba(75, 192, 192, 0.4)'
        };

        if (Object.keys(appointmentsData).length > 0) {
            new Chart(document.getElementById('graficoAppointments'), {
                type: 'line',
                data: {
                    labels: Object.keys(appointmentsData),
                    datasets: [{
                        label: 'N° de Turnos',
                        data: Object.values(appointmentsData),
                        backgroundColor: colores.fondo,
                        borderColor: colores.borde,
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {legend: {display: false}},
                    scales: {y: {beginAtZero: true}}
                }
            });
        }
    });
</script>
</body>
</html>
